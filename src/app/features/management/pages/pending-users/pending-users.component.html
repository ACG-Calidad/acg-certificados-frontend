<div class="pending-users-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Usuarios Pendientes</h1>
    <p class="subtitle">Usuarios con calificación en cursos pendientes de certificar</p>
  </div>

  <!-- Filters Section -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <!-- Search -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar</mat-label>
          <input matInput
                 [(ngModel)]="searchTerm"
                 (ngModelChange)="applyFilters()"
                 placeholder="Nombre, email, documento...">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <!-- Course Filter -->
        <mat-form-field appearance="outline" class="course-field">
          <mat-label>Curso</mat-label>
          <mat-select [(ngModel)]="selectedCourse" (selectionChange)="applyFilters()">
            <mat-option [value]="null">Todos los cursos</mat-option>
            <mat-option *ngFor="let course of courses" [value]="course.id">
              {{ course.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Minimum Grade Filter -->
        <mat-form-field appearance="outline" class="grade-field">
          <mat-label>Calificación mínima</mat-label>
          <mat-select [(ngModel)]="minGradeFilter" (selectionChange)="applyFilters()">
            <mat-option [value]="null">Todas</mat-option>
            <mat-option [value]="80">≥ 80% (Aprobados)</mat-option>
            <mat-option [value]="90">≥ 90%</mat-option>
            <mat-option [value]="70">≥ 70%</mat-option>
            <mat-option [value]="60">≥ 60%</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Date Range -->
        <mat-form-field appearance="outline" class="date-field">
          <mat-label>Fecha desde</mat-label>
          <input matInput [matDatepicker]="pickerFrom" [(ngModel)]="dateFrom" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
          <mat-datepicker #pickerFrom></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="date-field">
          <mat-label>Fecha hasta</mat-label>
          <input matInput [matDatepicker]="pickerTo" [(ngModel)]="dateTo" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
          <mat-datepicker #pickerTo></mat-datepicker>
        </mat-form-field>

        <button mat-icon-button (click)="clearFilters()" matTooltip="Limpiar filtros">
          <mat-icon>clear_all</mat-icon>
        </button>
      </div>

      <!-- Quick Filters -->
      <div class="quick-filters">
        <button mat-stroked-button color="primary" (click)="filterApproved()">
          <mat-icon>check_circle</mat-icon>
          Solo aprobados (≥80%)
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando usuarios pendientes...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadPendingUsers()">
      Reintentar
    </button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredUsers.length === 0" class="empty-container">
    <mat-icon>check_circle</mat-icon>
    <p>No hay usuarios pendientes</p>
    <p class="empty-subtitle">
      {{ searchTerm || selectedCourse || minGradeFilter || dateFrom || dateTo ? 'No se encontraron resultados con los filtros aplicados' : 'No hay usuarios con calificaciones pendientes de certificar' }}
    </p>
  </div>

  <!-- Table Section -->
  <mat-card *ngIf="!loading && !error && filteredUsers.length > 0" class="table-card">
    <!-- Action Bar -->
    <div class="action-bar">
      <div class="selection-info">
        <mat-checkbox
          [checked]="isAllSelected()"
          [indeterminate]="!isAllSelected() && selection.selected.length > 0"
          (change)="toggleAllSelection()">
        </mat-checkbox>
        <span class="selection-count" *ngIf="selection.selected.length > 0">
          {{ selection.selected.length }} seleccionado(s)
        </span>
        <span class="total-count">
          {{ filteredUsers.length }} usuario(s) pendiente(s)
        </span>
      </div>
      <button mat-raised-button
              color="primary"
              [disabled]="selection.selected.length === 0"
              (click)="openApproveDialog()">
        <mat-icon>verified</mat-icon>
        Aprobar y Generar Certificados
      </button>
    </div>

    <!-- Data Table -->
    <div class="table-container">
      <table mat-table [dataSource]="filteredUsers" class="pending-table">
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let user">
            <mat-checkbox
              [checked]="selection.isSelected(user)"
              (click)="$event.stopPropagation()"
              (change)="selection.toggle(user)">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- User Info Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>Usuario</th>
          <td mat-cell *matCellDef="let user">
            <div class="user-info">
              <span class="user-name">{{ user.firstname }} {{ user.lastname }}</span>
              <span class="user-email">{{ user.email }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Document Column -->
        <ng-container matColumnDef="document">
          <th mat-header-cell *matHeaderCellDef>Documento</th>
          <td mat-cell *matCellDef="let user">{{ user.idnumber || '-' }}</td>
        </ng-container>

        <!-- Course Column -->
        <ng-container matColumnDef="course">
          <th mat-header-cell *matHeaderCellDef>Curso</th>
          <td mat-cell *matCellDef="let user">
            <div class="course-info">
              <span class="course-name">{{ user.course_name }}</span>
              <span class="course-code">{{ user.course_shortname }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Grade Column -->
        <ng-container matColumnDef="grade">
          <th mat-header-cell *matHeaderCellDef>Calificación</th>
          <td mat-cell *matCellDef="let user">
            <span *ngIf="user.grade !== null"
                  class="grade"
                  [class.grade-approved]="user.grade >= 80"
                  [class.grade-low]="user.grade < 80">
              {{ user.grade | number:'1.1-1' }}%
            </span>
            <span *ngIf="user.grade === null" class="no-grade">-</span>
          </td>
        </ng-container>

        <!-- Grade Date Column -->
        <ng-container matColumnDef="grade_date">
          <th mat-header-cell *matHeaderCellDef>Fecha Calificación</th>
          <td mat-cell *matCellDef="let user">{{ formatDate(user.grade_date) }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [class.selected]="selection.isSelected(row)"
            (click)="selection.toggle(row)"></tr>
      </table>
    </div>
  </mat-card>
</div>
